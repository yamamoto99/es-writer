name: build and test
run-name: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç”Ÿæˆ ðŸš€
on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: yamamoto99/es-writer

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install docker-compose -y

      - name: ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ãƒ­ã‚°ã‚¤ãƒ³
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Compose ãƒ“ãƒ«ãƒ‰
        working-directory: ./backend
        run: docker-compose build

      - name: ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆè¡¨ç¤º
        run: docker images

      - name: Docker Compose ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¿ã‚°ä»˜ã‘
        working-directory: ./backend
        run: |
          docker tag $(docker-compose images -q api) ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: å¤‰æ•°ã®ç¢ºèª
        run: |
          echo 'Current path:'
          pwd

      - name: ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
        run: |
          echo "COGNITO_REGION=${{ secrets.COGNITO_REGION }}" >> $GITHUB_ENV
          echo "COGNITO_CLIENT_ID=${{ secrets.COGNITO_CLIENT_ID }}" >> $GITHUB_ENV
          echo "TOKEN_KEY_URL=${{ secrets.TOKEN_KEY_URL }}" >> $GITHUB_ENV
          echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> $GITHUB_ENV
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> $GITHUB_ENV

      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
